import { promises as fs } from 'fs';

import ImgLoaderOptions from '../types/ImgLoaderOptions';
import deriveExportOptions from './deriveExportOptions';
import getDefaultQuality from './getDefaultQuality';


const base = `
// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT.
// TO UPDATE, SET THE generateDeclarations OPTION OF bismuth-img-loader TO true
// AND RUN WEBPACK ONCE IN DEVELOPMENT MODE.


type _BismuthImage = {
	src: string;
	width: number;
	height: number;
};

type _WithMeta = {
	prefix: string;
	alpha: boolean;
}

type _WithWebp = {
	webp: string;
};

type _WithBasis = {
	basis: string;
};

type _WithThumbnail = {
	thumbnail: {
		data: string;
		width: number;
		height: number;
	};
};

type BismuthImage =
	_BismuthImage
	& _WithMeta
	& Partial<_WithWebp>
	& Partial<_WithBasis>
	& Partial<_WithThumbnail>
	& {
		sizes: Record<string, Partial<_BismuthImage & _WithWebp & _WithBasis>>;
	};

`;


const exts = [
	'*.jpg',
	'*.jpeg',
	'*.png',
	'*.gif',
	'*.svg',
];


function declaration({
	options,
	ext,
	mode = '',
	quality = '',
}: {
	options: ImgLoaderOptions;
	ext: string;
	mode?: string;
	quality?: string;
}) {
	const exportOptions = deriveExportOptions({
		options,
		mode: mode || 'default',
		quality: quality || getDefaultQuality( options, mode || 'default' ),
	});

	const types: string[] = ['_BismuthImage', '_WithMeta'];
	const sizeTypes: string[] = ['_BismuthImage'];

	if ( exportOptions.thumbnail ) {
		types.push( '_WithThumbnail' );
	}
	if ( exportOptions.emitWebp ) {
		types.push( '_WithWebp' );
		sizeTypes.push( '_WithWebp' );
	}
	if ( exportOptions.emitBasis ) {
		types.push( '_WithBasis' );
		sizeTypes.push( '_WithBasis' );
	}

	const sizes = Object.keys( exportOptions.sizes ).filter( s => s !== 'default' );

	const params = [];
	if ( mode ) params.push( `mode=${mode}` );
	if ( quality ) params.push( `quality=${quality}` );


	return `
declare module '${ext}${params.length > 0 ? `?${params.join( '&' )}` : ''}' {
	const e: ${types.join( ' & ' )} & {
		sizes: ${
	sizes.length > 0
		? `Record<'${sizes.join( "' | '" )}', ${sizeTypes.join( ' & ' )}>`
		: '{}'
};
	};
	export default e;
}
`;
}


export default function generateDeclarations( options: ImgLoaderOptions ): void {
	const modes = Object.keys( options.modes );
	const qualityLevels = Object.keys( options.qualityLevels );

	let output = `${base}`;

	exts.forEach( ext => {
		output += declaration({
			options,
			ext,
		});

		qualityLevels.forEach( quality => {
			output += declaration({
				options,
				ext,
				quality,
			});
		});

		modes.forEach( mode => {
			output += declaration({
				options,
				ext,
				mode,
			});

			qualityLevels.forEach( quality => {
				output += declaration({
					options,
					ext,
					mode,
					quality,
				});
			});
		});
	});

	fs.writeFile( 'img-imports.d.ts', output );
}
